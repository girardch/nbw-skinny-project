---
title: "skinny_questions"
output: html_document
---

```{r}
rm(list = ls())

library(dplyr)
library(stringr)
library(lubridate)
library(readr)

# 1. Read the CSV
claire_skinny_dorsals_in_ <- read_csv("data/claire_skinny_dorsals(in).csv")

# 2. Clean and subset
df_subset <- claire_skinny_dorsals_in_ %>%
  # Make the column names easier to use
  rename(
    Keyword_export = `Keyword-export`,
    Date_Time      = `Date Time`
  ) %>%
  # Make sure the key columns are plain character before using them
  mutate(
    Keyword_export = as.character(Keyword_export),
    Date_Time      = as.character(Date_Time)
  ) %>%
  # Derive Sex, Age, and parse Date_Time
  mutate(
    Sex = dplyr::case_when(
      str_detect(Keyword_export, "Male")    ~ "Male",
      str_detect(Keyword_export, "FemaleJ") ~ "FemaleJ",
      TRUE                                  ~ NA_character_
    ),
    Age = dplyr::case_when(
      str_detect(Keyword_export, regex("juv/calf", ignore_case = TRUE)) ~ "Juvenile/Calf",
      str_detect(Keyword_export, regex("juv",      ignore_case = TRUE)) ~ "Juvenile",
      str_detect(Keyword_export, regex("calf",     ignore_case = TRUE)) ~ "Calf",
      TRUE                                                              ~ "Adult"
    ),
    Date_Time = mdy_hm(Date_Time, quiet = TRUE)
  ) %>%
  select(Title, Sex, Age, Date_Time)

# Quick check
head(df_subset)

```

```{r}
library(dplyr)
library(stringr)
library(lubridate)
library(readr)

df <- read_csv("data/claire_skinny_dorsals(in).csv",
               show_col_types = FALSE) %>%
  rename(
    Keyword_export = `Keyword-export`,
    Date_Time      = `Date Time`
  )


# Per-photo data with Skinny flag
df_subset <- df %>%
  mutate(
    Sex = case_when(
      str_detect(Keyword_export, "Male")    ~ "Male",
      str_detect(Keyword_export, "FemaleJ") ~ "FemaleJ",
      TRUE                                  ~ NA_character_
    ),
    Age = case_when(
      str_detect(Keyword_export,
                 regex("juv\\s*/\\s*calf|jut\\s*/\\s*calf",
                       ignore_case = TRUE)) ~ "Juvenile/Calf",
      str_detect(Keyword_export,
                 regex("calf", ignore_case = TRUE)) ~ "Calf",
      str_detect(Keyword_export,
                 regex("juv",  ignore_case = TRUE)) ~ "Juvenile",
      TRUE ~ "Adult"
    ),
    Skinny = if_else(
      str_detect(Keyword_export,
                 regex("claire_skinny", ignore_case = TRUE)),
      "Yes", "No"
    ),
    Date_Time = as.Date(mdy_hm(Date_Time, quiet = TRUE)),
    Date      = Date_Time
  ) %>%
  select(Title, Sex, Age, Skinny, Date_Time, Date)

# One row per whale per day
df_daily <- df_subset %>%
  group_by(Title, Date) %>%
  summarise(
    Sex    = first(na.omit(Sex), default = NA_character_),
    Age    = first(na.omit(Age), default = NA_character_),
    Skinny = if_else(any(Skinny == "Yes", na.rm = TRUE),
                     "Yes", "No"),
    .groups = "drop"
  ) %>%
  transmute(Title, Sex, Age, Skinny, Date_Time = Date)

head(df_daily)

write.csv(df_daily, "df_daily_cleaned.csv", row.names = FALSE)


```


add year column
```{r}
library(lubridate)

df_daily <- df_daily %>%
  dplyr::mutate(Year = year(Date_Time))

write.csv(df_daily, "df_daily.csv", row.names = FALSE)

```


```{r}
table(df_daily$Skinny)

str(df_daily$Sex)
df_daily$Sex <- factor(df_daily$Sex)

table(df_daily$Sex, df_daily$Skinny)


```

bodyCondition ~ sex + (1|Year)
```{r}
library(lme4)

# Convert Skinny to a binary factor (1 = Yes, 0 = No)
df_daily$Skinny <- ifelse(df_daily$Skinny == "Yes", 1, 0)

mod1 <- glmer(Skinny ~ Sex + (1 | Year),
              data = df_daily,
              family = binomial)
summary(mod1)




```

in the above output suggests there are some variability among years-some years likely have more skinny individuals than others

checked to make sure every year in teh y axis was accounted for in the df dataset-it is, however there are a couple of years with not many whales-a mistake maybe? 2009 2008 1991 1988

The red lines indicate a lower than average probability of whales being detected as skinny
Blue lines indicate higher than average probability of whales being detected as skinny

```{r}
ranef(mod1)$Year

#install.packages("sjPlot")
library(sjPlot)
plot_model(mod1, type = "re", sort.est = TRUE)

```

trying to fit the effect as a GAM
-unsure if i did it right or what im looking for?
```{r}
library(mgcv)

gam_year <- gam(Skinny ~ s(Year, k = 5),
                data   = df_daily,
                family = binomial,
                method = "REML")
summary(gam_year)
plot(gam_year, pages = 1)


```


skinnyness as an indicator of health--> if skinny is it the last year seen?-->modelling dissapearance
```{r}
rm(list = ls())

library(dplyr)
library(stringr)
library(lubridate)
library(readr)

# 1. Read the original Lightroom export
df <- read_csv("data/claire_skinny_dorsals(in).csv",
               show_col_types = FALSE) %>%
  rename(
    Keyword_export = `Keyword-export`,
    Date_Time      = `Date Time`
  )

# 2. Add Skinny flag and Year column
df2 <- df %>%
  mutate(
    Skinny = str_detect(Keyword_export, regex("skinny", ignore_case = TRUE)),
    Date_Time = mdy_hm(Date_Time, quiet = TRUE),
    Year = year(Date_Time)
  )

# 3. Table of all whales that were skinny & the year(s) they were skinny
skinny_whales <- df2 %>%
  filter(Skinny) %>%
  distinct(Title, Year)

# 4. Table of each whale's LAST year seen (from the full dataset)
last_year_seen <- df2 %>%
  group_by(Title) %>%
  summarise(last_year_seen = max(Year, na.rm = TRUE), .groups = "drop")

# 5. Add the last-year-seen info to the skinny whale table
skinny_with_last <- skinny_whales %>%
  left_join(last_year_seen, by = "Title") %>%
  arrange(Title, Year)

# 6. View results
View(skinny_with_last)

write_csv(skinny_with_last, "skinny_whales_with_last_year.csv")


```

count where year == year_last_seen

also calculate proportion of whales who dissapear from catalogue while skinny
```{r}
sum(skinny_with_last$Year == skinny_with_last$last_year_seen, na.rm = TRUE)

mean(skinny_with_last$Year == skinny_with_last$last_year_seen)

```



average number of social partners of skinny whales
-each whale counted once per year
-doubles possible-consider that whales may recover 
```{r}
library(dplyr)

skinny_social <- merged_df %>%
  group_by(Title, Year) %>%
  summarise(
    # was this whale ever labelled skinny in this year?
    Skinny_year = any(Skinny == "Yes", na.rm = TRUE),

    # social metrics (constant within Titleâ€“Year, so just take first)
    Degree   = first(Degree),
    Strength = first(Strength),
    .groups = "drop"
  )

avg_social_skinny <- skinny_social %>%
  filter(Skinny_year) %>%
  summarise(
    n_whale_years = n(),
    mean_degree   = mean(Degree,   na.rm = TRUE),
    sd_degree     = sd(Degree,     na.rm = TRUE),
    mean_strength = mean(Strength, na.rm = TRUE)
  )

avg_social_skinny

avg_social_nonskinny <- skinny_social %>%
  filter(!Skinny_year) %>%
  summarise(
    n_whale_years = n(),
    mean_degree   = mean(Degree,   na.rm = TRUE),
    sd_degree     = sd(Degree,     na.rm = TRUE),
    mean_strength = mean(Strength, na.rm = TRUE)
  )

avg_social_nonskinny

```





used associated_entries from NBW thesis to determine average group size for each year
```{r}
library(dplyr)
library(lubridate)
library(igraph)

# ---- load ----
assoc <- read.csv("data/associated_entries.csv", stringsAsFactors = FALSE) %>%
  mutate(
    Time_A = ymd_hms(Time_A, tz = "UTC"),
    Time_B = ymd_hms(Time_B, tz = "UTC"),
    Title_A = as.character(Title_A),
    Title_B = as.character(Title_B)
  )

# ---- unique observation nodes: (Title, Time) ----
nodes <- bind_rows(
  assoc %>% transmute(Title = Title_A, Time = Time_A),
  assoc %>% transmute(Title = Title_B, Time = Time_B)
) %>%
  distinct() %>%
  mutate(node_id = row_number())

# ---- edges as node_id pairs ----
edges <- assoc %>%
  transmute(
    Title_A = Title_A, Time_A = Time_A,
    Title_B = Title_B, Time_B = Time_B
  ) %>%
  left_join(nodes %>% rename(Title_A = Title, Time_A = Time, from = node_id),
            by = c("Title_A", "Time_A")) %>%
  left_join(nodes %>% rename(Title_B = Title, Time_B = Time, to = node_id),
            by = c("Title_B", "Time_B")) %>%
  transmute(from, to) %>%
  filter(!is.na(from), !is.na(to), from != to) %>%
  distinct()

# ---- build graph WITHOUT vertex names ----
# map node_id -> 1..N so igraph edgelist is clean
id_map <- nodes$node_id
edges_mat <- cbind(match(edges$from, id_map),
                   match(edges$to,   id_map))

g <- graph_from_edgelist(edges_mat, directed = FALSE)

# connected components (= encounters)
membership <- components(g)$membership  # length = nrow(nodes)
nodes$encounter_id <- membership

# group size per encounter = # unique Titles in that component
encounter_sizes <- nodes %>%
  group_by(encounter_id) %>%
  summarise(group_size = n_distinct(Title), .groups = "drop")

nodes <- nodes %>%
  left_join(encounter_sizes, by = "encounter_id") %>%
  mutate(Year = year(Time))

# ---- average group size per animal per year ----
avg_group_size_by_year <- nodes %>%
  group_by(Title, Year) %>%
  summarise(
    mean_group_size = mean(group_size, na.rm = TRUE),
    n_observations = n(),
    n_encounters = n_distinct(encounter_id),
    .groups = "drop"
  ) %>%
  arrange(Title, Year)

avg_group_size_by_year

write_csv(avg_group_size_by_year, "savg_group_size_by_year.csv")

```

now want to attach skinny values for year--could create df that shows title-year-skinny(Y/N)
possibility that animals may be classified as skinny during one encounter but not in another--could do proportion skinny for that year ?

use df_daily to make df-start w proportion
```{r}
library(dplyr)
library(lubridate)

df_daily <- read.csv("data/df_daily.csv")

library(dplyr)

skinny_by_year <- df_daily %>%
  mutate(
    Skinny_bin = ifelse(tolower(trimws(Skinny)) == "yes", 1, 0)
  ) %>%
  group_by(Title, Year, Date_Time) %>%
  summarise(Skinny_day = max(Skinny_bin, na.rm = TRUE), .groups = "drop") %>%
  group_by(Title, Year) %>%
  summarise(
    prop_skinny = mean(Skinny_day, na.rm = TRUE),
    n_days = n(),
    .groups = "drop"
  ) %>%
  arrange(Title, Year)

skinny_by_year

write_csv(skinny_by_year, "skinny_by_year.csv")
```

merge the dataframes to make one 
one row per animal per year w proportion skinny and average group size
```{r}
skinny_avg_group_year <- avg_group_size_by_year %>% 
  left_join( 
    skinny_by_year, 
    by = c("Title", "Year") 
    ) 
skinny_avg_group_year

write_csv(skinny_avg_group_year, "skinny_avg_group_year")

```

average group size of animals w prop skinny>0 
vs
average group size of animals w prop skinny = 0

```{r}

final_df <- skinny_avg_group_year %>%
  mutate(
    skinny_year = ifelse(prop_skinny > 0, "Skinny", "Not skinny")
  )

avg_group_by_skinny <- final_df %>%
  group_by(skinny_year) %>%
  summarise(
    mean_group_size = mean(mean_group_size, na.rm = TRUE),
    sd_group_size   = sd(mean_group_size, na.rm = TRUE),
    n_years         = n(),
    .groups = "drop"
  )

avg_group_by_skinny

write_csv(avg_group_by_skinny, "avg_group_by_skinny")

```


want to find out if proportion skinny gets easier to detect with digital cameras
use the skinny_by_year df?
```{r}
skinny_by_year <- skinny_by_year %>%
  mutate(
    camera_era = ifelse(Year > 2007, "Digital", "Film")
  )
table(skinny_by_year$camera_era)

skinny_by_year %>%
  group_by(camera_era) %>%
  summarise(
    mean_prop_skinny = mean(prop_skinny, na.rm = TRUE),
    sd_prop_skinny   = sd(prop_skinny, na.rm = TRUE),
    n_years          = n(),
    .groups = "drop"
  )




```
use binomial
```{r}
skinny_by_year <- skinny_by_year %>%
  mutate(
    n_skinny = round(prop_skinny * n_days),
    n_not_skinny = n_days - n_skinny
  )

mod_camera_binom <- glmer(
  cbind(n_skinny, n_not_skinny) ~ camera_era + (1 | Title),
  data = skinny_by_year,
  family = binomial
)

summary(mod_camera_binom)



```

visualize?
```{r}
library(ggplot2)

ggplot(skinny_by_year, aes(x = camera_era, y = prop_skinny)) +
  geom_boxplot(outlier.alpha = 0.3) +
  geom_jitter(width = 0.15, alpha = 0.4) +
  theme_classic() +
  labs(y = "Proportion of days skinny")



```

